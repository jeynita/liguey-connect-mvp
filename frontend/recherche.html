<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recherche - Liguey Connect</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header>
        <div class="header-container">
            <a href="index.html" class="logo">Liguey<span>Connect</span></a>
            <nav>
                <ul>
                    <li><a href="index.html">Accueil</a></li>
                    <li><a href="recherche.html" class="active">Rechercher</a></li>
                    <li><a href="connexion.html">Connexion</a></li>
                    <li><a href="inscription.html" class="btn btn-secondary btn-sm">S'inscrire</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <section class="section">
        <div class="container">
            <h1 class="text-center mb-4">Rechercher</h1>
            
            <!-- Tabs -->
            <div class="d-flex justify-between align-center mb-3" style="border-bottom: 2px solid var(--color-background); padding-bottom: 1rem;">
                <button id="tab-prestataires" class="btn btn-outline" onclick="changerTab('prestataires')" style="flex: 1; margin-right: 1rem;">
                    üîß Prestataires de services
                </button>
                <button id="tab-offres" class="btn btn-outline" onclick="changerTab('offres')" style="flex: 1;">
                    üíº Offres d'emploi
                </button>
            </div>

            <!-- FILTRES PRESTATAIRES -->
            <div id="filtres-prestataires" class="filters">
                <div class="filter-row">
                    <div class="form-group">
                        <label class="form-label">Recherche</label>
                        <input type="text" id="recherche-prestataires" class="form-input" placeholder="Nom, m√©tier, comp√©tences...">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">M√©tier</label>
                        <select id="metier" class="form-select">
                            <option value="">Tous les m√©tiers</option>
                            <option value="Plomberie">Plomberie</option>
                            <option value="√âlectricit√©">√âlectricit√©</option>
                            <option value="Menuiserie">Menuiserie</option>
                            <option value="Ma√ßonnerie">Ma√ßonnerie</option>
                            <option value="Peinture">Peinture</option>
                            <option value="Jardinage">Jardinage</option>
                            <option value="M√©canique">M√©canique</option>
                            <option value="Informatique">Informatique</option>
                            <option value="Couture">Couture</option>
                            <option value="Nettoyage">Nettoyage</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">R√©gion</label>
                        <select id="region-prestataires" class="form-select">
                            <option value="">Toutes les r√©gions</option>
                            <option value="Dakar">Dakar</option>
                            <option value="Thi√®s">Thi√®s</option>
                            <option value="Saint-Louis">Saint-Louis</option>
                            <option value="Kaolack">Kaolack</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Disponibilit√©</label>
                        <select id="disponibilite" class="form-select">
                            <option value="">Toutes</option>
                            <option value="immediat">Imm√©diate</option>
                            <option value="sous_24h">Sous 24h</option>
                            <option value="sous_semaine">Sous une semaine</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Trier par</label>
                        <select id="tri-prestataires" class="form-select">
                            <option value="note">Meilleure note</option>
                            <option value="tarif_asc">Tarif croissant</option>
                            <option value="tarif_desc">Tarif d√©croissant</option>
                            <option value="experience">Plus d'exp√©rience</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-primary btn-block" onclick="rechercherPrestataires()">Rechercher</button>
                    </div>
                </div>
            </div>

            <!-- FILTRES OFFRES -->
            <div id="filtres-offres" class="filters" style="display: none;">
                <div class="filter-row">
                    <div class="form-group">
                        <label class="form-label">Recherche</label>
                        <input type="text" id="recherche-offres" class="form-input" placeholder="Titre, comp√©tences...">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Type de contrat</label>
                        <select id="type-contrat" class="form-select">
                            <option value="">Tous</option>
                            <option value="CDD">CDD</option>
                            <option value="CDI">CDI</option>
                            <option value="mission">Mission ponctuelle</option>
                            <option value="stage">Stage</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">R√©gion</label>
                        <select id="region-offres" class="form-select">
                            <option value="">Toutes les r√©gions</option>
                            <option value="Dakar">Dakar</option>
                            <option value="Thi√®s">Thi√®s</option>
                            <option value="Saint-Louis">Saint-Louis</option>
                            <option value="Kaolack">Kaolack</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-primary btn-block" onclick="rechercherOffres()">Rechercher</button>
                    </div>
                </div>
            </div>

            <!-- R√âSULTATS PRESTATAIRES -->
            <div id="resultats-prestataires" class="mt-4">
                <h2 id="titre-resultats-prestataires">Prestataires disponibles</h2>
                <div id="liste-prestataires" class="grid grid-3 mt-3">
                    <div class="spinner"></div>
                </div>
            </div>

            <!-- R√âSULTATS OFFRES -->
            <div id="resultats-offres" class="mt-4" style="display: none;">
                <h2 id="titre-resultats-offres">Offres d'emploi disponibles</h2>
                <div id="liste-offres" class="grid grid-2 mt-3">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </section>

    <footer>
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; 2026 Liguey Connect</p>
            </div>
        </div>
    </footer>

    <script src="js/main.js"></script>
    <script>
        let tabActif = 'prestataires';
        
        // Changer de tab
        function changerTab(tab) {
            tabActif = tab;
            
            // Mise √† jour des boutons
            document.getElementById('tab-prestataires').classList.toggle('btn-primary', tab === 'prestataires');
            document.getElementById('tab-prestataires').classList.toggle('btn-outline', tab !== 'prestataires');
            document.getElementById('tab-offres').classList.toggle('btn-primary', tab === 'offres');
            document.getElementById('tab-offres').classList.toggle('btn-outline', tab !== 'offres');
            
            // Afficher/masquer les sections
            document.getElementById('filtres-prestataires').style.display = tab === 'prestataires' ? 'block' : 'none';
            document.getElementById('filtres-offres').style.display = tab === 'offres' ? 'block' : 'none';
            document.getElementById('resultats-prestataires').style.display = tab === 'prestataires' ? 'block' : 'none';
            document.getElementById('resultats-offres').style.display = tab === 'offres' ? 'block' : 'none';
            
            // Lancer la recherche
            if (tab === 'prestataires') {
                rechercherPrestataires();
            } else {
                rechercherOffres();
            }
        }
        
        // Rechercher des prestataires
        async function rechercherPrestataires() {
            const container = document.getElementById('liste-prestataires');
            container.innerHTML = '<div class="spinner"></div>';
            
            const filtres = {
                q: document.getElementById('recherche-prestataires').value.trim(),
                metier: document.getElementById('metier').value,
                region: document.getElementById('region-prestataires').value,
                disponibilite: document.getElementById('disponibilite').value,
                tri: document.getElementById('tri-prestataires').value,
                limite: 12
            };
            
            // Supprimer les filtres vides
            Object.keys(filtres).forEach(key => {
                if (!filtres[key]) delete filtres[key];
            });
            
            try {
                const response = await LigueyConnect.rechercherPrestataires(filtres);
                
                if (response.success && response.data.prestataires.length > 0) {
                    document.getElementById('titre-resultats-prestataires').textContent = 
                        `${response.data.total} prestataire(s) trouv√©(s)`;
                    
                    container.innerHTML = response.data.prestataires.map(p => `
                        <div class="card">
                            <div class="card-header">
                                <img src="${p.photo_profil || 'https://via.placeholder.com/60'}" 
                                    alt="${p.nom}" class="card-avatar">
                                <div>
                                    <h3 class="card-title">${p.prenom} ${p.nom}</h3>
                                    <p class="card-subtitle">${p.metier}</p>
                                    ${p.profil_verifie ? '<span class="badge badge-success">‚úì V√©rifi√©</span>' : ''}
                                </div>
                            </div>
                            <div class="card-body">
                                <p>${p.description ? p.description.substring(0, 100) + '...' : 'Prestataire qualifi√©'}</p>
                                ${LigueyConnect.genererEtoiles(parseFloat(p.note_moyenne))}
                                <p class="mt-2"><strong>Exp√©rience :</strong> ${p.annees_experience} ans</p>
                                <p>üìç ${p.commune}, ${p.region}</p>
                                <p><strong>${p.tarif_horaire ? p.tarif_horaire.toLocaleString() + ' FCFA/h' : 'Sur devis'}</strong></p>
                            </div>
                            <div class="card-footer">
                                <span class="badge badge-warning">${p.disponibilite}</span>
                                <a href="tel:${p.telephone}" class="btn btn-primary btn-sm">Appeler</a>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p class="text-center">Aucun prestataire trouv√©. Essayez de modifier vos crit√®res de recherche.</p>';
                }
            } catch (error) {
                container.innerHTML = '<p class="text-center">Erreur lors de la recherche.</p>';
            }
        }
        
        // Rechercher des offres
        async function rechercherOffres() {
            const container = document.getElementById('liste-offres');
            container.innerHTML = '<div class="spinner"></div>';
            
            const filtres = {
                recherche: document.getElementById('recherche-offres').value.trim(),
                type_contrat: document.getElementById('type-contrat').value,
                region: document.getElementById('region-offres').value,
                limite: 12
            };
            
            // Supprimer les filtres vides
            Object.keys(filtres).forEach(key => {
                if (!filtres[key]) delete filtres[key];
            });
            
            try {
                const response = await LigueyConnect.recupererOffres(filtres);
                
                if (response.success && response.data.offres.length > 0) {
                    document.getElementById('titre-resultats-offres').textContent = 
                        `${response.data.pagination.total} offre(s) trouv√©e(s)`;
                    
                    container.innerHTML = response.data.offres.map(o => `
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <h3 class="card-title">${o.titre}</h3>
                                    <p class="card-subtitle">${o.recruteur_nom} ${o.recruteur_prenom}</p>
                                </div>
                            </div>
                            <div class="card-body">
                                <p>${o.description.substring(0, 150)}...</p>
                                <div class="d-flex gap-2 mt-2">
                                    <span class="badge badge-primary">${o.type_contrat}</span>
                                    <span class="badge badge-secondary">üìç ${o.commune}</span>
                                </div>
                                ${o.salaire_min ? `<p class="mt-2"><strong>Salaire :</strong> ${o.salaire_min.toLocaleString()} - ${o.salaire_max ? o.salaire_max.toLocaleString() : '...'} FCFA</p>` : ''}
                            </div>
                            <div class="card-footer">
                                <span>${LigueyConnect.formaterDate(o.date_creation)}</span>
                                <button class="btn btn-primary btn-sm" onclick="postuler(${o.id})">Postuler</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p class="text-center">Aucune offre trouv√©e. Essayez de modifier vos crit√®res de recherche.</p>';
                }
            } catch (error) {
                container.innerHTML = '<p class="text-center">Erreur lors de la recherche.</p>';
            }
        }
        
        // Postuler √† une offre
        function postuler(offreId) {
            const user = LigueyConnect.verifierConnexion();
            if (!user) {
                LigueyConnect.afficherAlerte('Veuillez vous connecter pour postuler', 'warning');
                setTimeout(() => window.location.href = 'connexion.html', 1500);
                return;
            }
            
            if (user.type_utilisateur !== 'demandeur') {
                LigueyConnect.afficherAlerte('Seuls les demandeurs d\'emploi peuvent postuler', 'error');
                return;
            }
            
            // Rediriger vers la page de candidature
            window.location.href = `candidater.html?offre=${offreId}`;
        }
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            // R√©cup√©rer les param√®tres URL
            const params = new URLSearchParams(window.location.search);
            const type = params.get('type');
            const q = params.get('q');
            const metier = params.get('metier');
            
            // Pr√©-remplir les champs
            if (q) {
                document.getElementById('recherche-prestataires').value = q;
                document.getElementById('recherche-offres').value = q;
            }
            
            if (metier) {
                document.getElementById('metier').value = metier;
            }
            
            // Changer de tab si sp√©cifi√©
            if (type === 'offres') {
                changerTab('offres');
            } else {
                changerTab('prestataires');
            }
        });
    </script>
</body>
</html>